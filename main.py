import json
import time
from dataclasses import dataclass
from datetime import datetime, timezone

import ccxt


def utc_day_key() -> str:
    return datetime.now(timezone.utc).strftime("%Y-%m-%d")


    def load_config(path="config.json"):
        with open(path, "r", encoding="utf-8") as f:
                return json.load(f)


                def rsi(closes, period=14):
                    if len(closes) < period + 1:
                            return None
                                gains = 0.0
                                    losses = 0.0
                                        for i in range(1, period + 1):
                                                diff = closes[-i] - closes[-i - 1]
                                                        if diff >= 0:
                                                                    gains += diff
                                                                            else:
                                                                                        losses += (-diff)
                                                                                            avg_gain = gains / period
                                                                                                avg_loss = losses / period
                                                                                                    if avg_loss == 0:
                                                                                                            return 100.0
                                                                                                                rs = avg_gain / avg_loss
                                                                                                                    return 100.0 - (100.0 / (1.0 + rs))


                                                                                                                    def rolling_vwap(ohlcv, window=20):
                                                                                                                        if len(ohlcv) < window:
                                                                                                                                return None
                                                                                                                                    chunk = ohlcv[-window:]
                                                                                                                                        pv = 0.0
                                                                                                                                            vv = 0.0
                                                                                                                                                for _, o, h, l, c, v in chunk:
                                                                                                                                                        typical = (h + l + c) / 3.0
                                                                                                                                                                pv += typical * v
                                                                                                                                                                        vv += v
                                                                                                                                                                            if vv == 0:
                                                                                                                                                                                    return None
                                                                                                                                                                                        return pv / vv


                                                                                                                                                                                        def pct(price, ref):
                                                                                                                                                                                            return (price - ref) / ref * 100.0


                                                                                                                                                                                            @dataclass
                                                                                                                                                                                            class Position:
                                                                                                                                                                                                symbol: str
                                                                                                                                                                                                    side: str  # "long" / "short"
                                                                                                                                                                                                        entry_price: float
                                                                                                                                                                                                            qty: float
                                                                                                                                                                                                                entry_time: float
                                                                                                                                                                                                                    tp_price: float
                                                                                                                                                                                                                        sl_price: float
                                                                                                                                                                                                                            max_hold_seconds: int


                                                                                                                                                                                                                            class PaperBroker:
                                                                                                                                                                                                                                def __init__(self, start_usdt: float):
                                                                                                                                                                                                                                        self.usdt = start_usdt
                                                                                                                                                                                                                                                self.positions = {}
                                                                                                                                                                                                                                                        self.realized_pnl = 0.0

                                                                                                                                                                                                                                                            def has_position(self, symbol: str) -> bool:
                                                                                                                                                                                                                                                                    return symbol in self.positions

                                                                                                                                                                                                                                                                        def open_position(self, pos: Position):
                                                                                                                                                                                                                                                                                self.positions[pos.symbol] = pos

                                                                                                                                                                                                                                                                                    def close_position(self, symbol: str, exit_price: float):
                                                                                                                                                                                                                                                                                            pos = self.positions.pop(symbol)
                                                                                                                                                                                                                                                                                                    if pos.side == "long":
                                                                                                                                                                                                                                                                                                                pnl = (exit_price - pos.entry_price) * pos.qty
                                                                                                                                                                                                                                                                                                                        else:
                                                                                                                                                                                                                                                                                                                                    pnl = (pos.entry_price - exit_price) * pos.qty
                                                                                                                                                                                                                                                                                                                                            self.realized_pnl += pnl
                                                                                                                                                                                                                                                                                                                                                    self.usdt += pnl
                                                                                                                                                                                                                                                                                                                                                            return pnl


                                                                                                                                                                                                                                                                                                                                                            def main():
                                                                                                                                                                                                                                                                                                                                                                cfg = load_config()

                                                                                                                                                                                                                                                                                                                                                                    symbols = cfg["symbols"]
                                                                                                                                                                                                                                                                                                                                                                        tf = cfg["timeframe"]
                                                                                                                                                                                                                                                                                                                                                                            loop_seconds = int(cfg["loop_seconds"])
                                                                                                                                                                                                                                                                                                                                                                                max_trades = int(cfg["max_trades_per_day"])
                                                                                                                                                                                                                                                                                                                                                                                    cooldown = int(cfg["cooldown_seconds_after_trade"])
                                                                                                                                                                                                                                                                                                                                                                                        max_losses_row = int(cfg["max_consecutive_losses"])

                                                                                                                                                                                                                                                                                                                                                                                            strat = cfg["strategy"]
                                                                                                                                                                                                                                                                                                                                                                                                rsi_period = int(strat["rsi_period"])
                                                                                                                                                                                                                                                                                                                                                                                                    vwap_window = int(strat["vwap_window"])
                                                                                                                                                                                                                                                                                                                                                                                                        min_dev = float(strat["min_vwap_deviation_pct"])

                                                                                                                                                                                                                                                                                                                                                                                                            risk = cfg["risk"]
                                                                                                                                                                                                                                                                                                                                                                                                                start_usdt = float(risk["paper_start_balance_usdt"])
                                                                                                                                                                                                                                                                                                                                                                                                                    risk_per_trade_pct = float(risk["risk_per_trade_pct"])
                                                                                                                                                                                                                                                                                                                                                                                                                        max_daily_loss_pct = float(risk["max_daily_loss_pct"])
                                                                                                                                                                                                                                                                                                                                                                                                                            daily_tp_pct = float(risk["daily_take_profit_pct"])

                                                                                                                                                                                                                                                                                                                                                                                                                                exchange = ccxt.binance({"enableRateLimit": True})
                                                                                                                                                                                                                                                                                                                                                                                                                                    broker = PaperBroker(start_usdt=start_usdt)

                                                                                                                                                                                                                                                                                                                                                                                                                                        day = utc_day_key()
                                                                                                                                                                                                                                                                                                                                                                                                                                            trades_today = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                consecutive_losses = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                    last_trade_time = 0.0
                                                                                                                                                                                                                                                                                                                                                                                                                                                        day_start_equity = broker.usdt

                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"MODE: PAPER | SYMBOLS: {symbols} | TF: {tf}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("Start equity (paper USDT):", broker.usdt)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("Ctrl+C aby zatrzymaÄ‡.\n")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                        while True:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                now = time.time()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        new_day = utc_day_key()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if new_day != day:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            day = new_day
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        trades_today = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    consecutive_losses = 0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                day_start_equity = broker.usdt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"\n=== NEW UTC DAY {day} ===\n")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    equity = broker.usdt
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            dd_pct = (equity - day_start_equity) / day_start_equity * 100.0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if dd_pct <= -max_daily_loss_pct:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print(f"[STOP] Daily loss limit hit: {dd_pct:.2f}%")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            time.sleep(loop_seconds)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        continue
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if dd_pct >= daily_tp_pct:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"[STOP] Daily take-profit hit: {dd_pct:.2f}%")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        time.sleep(loop_seconds)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if trades_today >= max_trades:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print("[STOP] Max trades/day reached.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    time.sleep(loop_seconds)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if consecutive_losses >= max_losses_row:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    print("[STOP] Max consecutive losses reached.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                time.sleep(loop_seconds)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if now - last_trade_time < cooldown:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                time.sleep(2)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    for symbol in symbols:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ohlcv = exchange.fetch_ohlcv(symbol, timeframe=tf, limit=max(60, vwap_window + rsi_period + 5))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"[{symbol}] fetch_ohlcv error:", e)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        closes = [x[4] for x in ohlcv]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    last_price = closes[-1]

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                val_rsi = rsi(closes, period=rsi_period)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            val_vwap = rolling_vwap(ohlcv, window=vwap_window)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if val_rsi is None or val_vwap is None:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    dev = pct(last_price, val_vwap)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if broker.has_position(symbol):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                pos = broker.positions[symbol]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                hold = now - pos.entry_time

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                hit_tp = (last_price >= pos.tp_price) if pos.side == "long" else (last_price <= pos.tp_price)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                hit_sl = (last_price <= pos.sl_price) if pos.side == "long" else (last_price >= pos.sl_price)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                timeout = hold >= pos.max_hold_seconds

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if hit_tp or hit_sl or timeout:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    pnl = broker.close_position(symbol, last_price)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        trades_today += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            last_trade_time = now
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if pnl < 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        consecutive_losses += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    consecutive_losses = 0

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        reason = "TP" if hit_tp else ("SL" if hit_sl else "TIME")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            print(f"[{symbol}] CLOSE {pos.side.upper()} @ {last_price:.4f} | PnL={pnl:.4f} USDT | {reason} | equity={broker.usdt:.2f}")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        long_signal = (dev <= -min_dev) and (val_rsi <= 30)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    short_signal = (dev >= min_dev) and (val_rsi >= 70)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if not (long_signal or short_signal):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            trade_risk_usdt = broker.usdt * (risk_per_trade_pct / 100.0)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        is_btc = symbol.startswith("BTC/")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if is_btc:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    tp_pct = float(strat["tp_pct_btc"]) / 100.0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    sl_pct = float(strat["sl_pct_btc"]) / 100.0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    max_hold = int(strat["max_hold_seconds_btc"])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tp_pct = float(strat["tp_pct_xrp"]) / 100.0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                sl_pct = float(strat["sl_pct_xrp"]) / 100.0
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                max_hold = int(strat["max_hold_seconds_xrp"])

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            qty = trade_risk_usdt / (last_price * sl_pct)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        qty = float(f"{qty:.6f}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    side = "long" if long_signal else "short"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if side == "long":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                tp_price = last_price * (1 + tp_pct)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                sl_price = last_price * (1 - sl_pct)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tp_price = last_price * (1 - tp_pct)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            sl_price = last_price * (1 + sl_pct)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        broker.open_position(Position(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        symbol=symbol,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        side=side,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        entry_price=last_price,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        qty=qty,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        entry_time=now,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        tp_price=tp_price,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        sl_price=sl_price,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        max_hold_seconds=max_hold
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                trades_today += 1
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            last_trade_time = now

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        print(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        f"[{symbol}] OPEN {side.upper()} @ {last_price:.4f} | "
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        f"RSI={val_rsi:.1f} VWAP={val_vwap:.4f} dev={dev:.2f}% | "
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        f"TP={tp_price:.4f} SL={sl_price:.4f} qty={qty} | trades_today={trades_today}/{max_trades}"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                time.sleep(1)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        time.sleep(loop_seconds)


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if __name__ == "__main__":
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            main()
                                                                                                                    return 100.0 - (100.0 / (1.0 + rs))


                                                                                                                    def rolling_vwap(ohlcv, window=20):
                                                                                                                        if len(ohlcv) < window:
                                                                                                                                return None
                                                                                                                                    chunk = ohlcv[-window:]
